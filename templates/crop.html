{% extends "base.html" %}

{% block title %}Crop Images Online - Free Image Cropping Tool | resizeimages.co.in{% endblock %}
{% block description %}Crop images online with precision. Extract specific portions of your images with our easy-to-use cropping tool.{% endblock %}
{% block keywords %}crop images, image cropping, crop photos, image editor, photo crop tool, extract image portion{% endblock %}

{% block hero %}
<div class="hero-section text-center">
  <div class="container">
    <div class="mb-3">
      <img src="{{ url_for('static', filename='images/logo.png') }}"
           alt="resizeimages.co.in logo"
           height="60"
           class="mb-3">
    </div>
    <h1 class="display-4 fw-bold mb-3">
      <i class="fas fa-crop-alt fa-lg me-3"></i>Crop Images Online
    </h1>
    <p class="lead mb-4">Extract specific portions of your images with precise cropping controls. Perfect for creating thumbnails or focusing on details.</p>
    <div class="row justify-content-center">
      <div class="col-md-4">
        <div class="card card-feature bg-white bg-opacity-10 border-0 text-white">
          <div class="card-body text-center">
            <i class="fas fa-crosshairs fa-2x mb-2"></i>
            <h5>Precise Control</h5>
            <p class="mb-0">Exact pixel-level cropping</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card card-feature bg-white bg-opacity-10 border-0 text-white">
          <div class="card-body text-center">
            <i class="fas fa-layer-group fa-2x mb-2"></i>
            <h5>Batch Processing</h5>
            <p class="mb-0">Crop multiple images at once</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card card-feature bg-white bg-opacity-10 border-0 text-white">
          <div class="card-body text-center">
            <i class="fas fa-magic fa-2x mb-2"></i>
            <h5>Smart Presets</h5>
            <p class="mb-0">Common aspect ratios available</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h3 class="card-title mb-0">
          <i class="fas fa-crop-alt me-2"></i>Crop Images
        </h3>
      </div>
      <div class="card-body">
        <div class="mb-3 text-muted">
          <strong>Upload constraints:</strong>
          Max files: <span class="badge bg-secondary">{{ max_files or 10 }}</span>,
          Types: <span class="badge bg-secondary">JPG, PNG, WebP</span>,
          Max size per file: <span class="badge bg-secondary">{{ config_max_mb or 25 }} MB</span>
        </div>

        {% if error %}
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
        </div>
        {% endif %}

        <form id="mainForm" action="/crop" method="post" enctype="multipart/form-data">
          <div id="dropArea" class="dropArea mb-3">
            <i class="fas fa-cloud-upload-alt fa-3x mb-2 text-muted"></i>
            <p class="mb-2">Click or drag & drop images here</p>
            <small class="text-muted">Supports JPG, PNG, WebP formats</small>
          </div>
          <input type="file" id="fileInput" name="images" accept="image/jpeg,image/jpg,image/png,image/webp" multiple style="display:none">

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Or paste direct image URL:</label>
              <input class="form-control" type="url" name="remote_url" placeholder="https://example.com/image.jpg">
            </div>
            <div class="col-md-6">
              <label class="form-label">Or Google Drive share link:</label>
              <input class="form-control" type="url" name="drive_url" placeholder="https://drive.google.com/...">
            </div>
          </div>

          <div class="card bg-light mb-3">
            <div class="card-body">
              <h5 class="card-title">Crop Settings</h5>
              
              <!-- Preset Buttons -->
              <div class="mb-3">
                <label class="form-label">Quick Presets:</label>
                <div class="btn-group w-100 mb-2" role="group">
                  <button type="button" class="btn btn-outline-secondary preset-btn" data-ratio="1:1">
                    <i class="fas fa-square me-1"></i>Square (1:1)
                  </button>
                  <button type="button" class="btn btn-outline-secondary preset-btn" data-ratio="4:3">
                    <i class="fas fa-tv me-1"></i>Standard (4:3)
                  </button>
                  <button type="button" class="btn btn-outline-secondary preset-btn" data-ratio="16:9">
                    <i class="fas fa-desktop me-1"></i>Widescreen (16:9)
                  </button>
                  <button type="button" class="btn btn-outline-secondary preset-btn" data-ratio="3:2">
                    <i class="fas fa-camera me-1"></i>Photo (3:2)
                  </button>
                </div>
                <small class="text-muted">Click a preset to auto-calculate dimensions, or set custom values below</small>
              </div>

              <!-- Manual Crop Settings -->
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">X Position (left offset):</label>
                  <div class="input-group">
                    <input type="number" class="form-control" name="crop_x" id="cropX" value="0" min="0" placeholder="0">
                    <span class="input-group-text">px</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Y Position (top offset):</label>
                  <div class="input-group">
                    <input type="number" class="form-control" name="crop_y" id="cropY" value="0" min="0" placeholder="0">
                    <span class="input-group-text">px</span>
                  </div>
                </div>
              </div>
              
              <div class="row g-3 mt-2">
                <div class="col-md-6">
                  <label class="form-label">Width:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" name="crop_width" id="cropWidth" value="500" min="1" placeholder="500">
                    <span class="input-group-text">px</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Height:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" name="crop_height" id="cropHeight" value="500" min="1" placeholder="500">
                    <span class="input-group-text">px</span>
                  </div>
                </div>
              </div>

              <!-- Visual Preview -->
              <div class="mt-3">
                <label class="form-label">Preview:</label>
                <div id="cropPreview" class="border border-2 border-success rounded p-3 text-center" style="background: repeating-linear-gradient(45deg, #f8f9fa, #f8f9fa 10px, #e9ecef 10px, #e9ecef 20px);">
                  <div id="cropArea" style="background: rgba(40, 167, 69, 0.2); border: 2px solid #28a745; position: relative; margin: 0 auto; min-height: 100px; width: 200px; height: 150px;">
                    <div class="position-absolute top-50 start-50 translate-middle">
                      <small class="text-success fw-bold">Crop Area<br><span id="previewDimensions">500Ã—500</span></small>
                    </div>
                  </div>
                  <small class="text-muted mt-2 d-block">Visual representation of crop area</small>
                </div>
              </div>
            </div>
          </div>

          <div id="selectionInfo" class="selection-info mt-3" style="display:none;">
            <div class="alert alert-info">
              <strong><span id="fileCount">0</span></strong> file(s) selected
            </div>
            <div id="thumbnails" class="d-flex flex-wrap"></div>
          </div>

          <div class="text-center mt-4">
            <button type="submit" class="btn btn-success btn-lg px-5">
              <i class="fas fa-crop-alt me-2"></i>Crop Images
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% if results %}
<div class="row justify-content-center mt-4">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          <i class="fas fa-check-circle me-2"></i>Crop Results
        </h4>
        {% if all_downloads and all_downloads|length > 0 %}
        <button id="downloadAll" class="btn btn-light btn-sm">
          <i class="fas fa-download me-1"></i>Download All
        </button>
        {% endif %}
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>File Name</th>
                <th>Original Size</th>
                <th>New Size</th>
                <th>Info</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for r in results %}
              <tr>
                <td>
                  {% if r.error %}
                    <i class="fas fa-exclamation-triangle text-danger me-1"></i>{{ r.name }}
                  {% else %}
                    <i class="fas fa-file-image text-success me-1"></i>{{ r.name }}
                  {% endif %}
                </td>
                {% if r.error %}
                <td colspan="4">
                  <span class="text-danger">Error: {{ r.error }}</span>
                </td>
                {% else %}
                <td>{{ r.original_size }}</td>
                <td>{{ r.new_size }}</td>
                <td>
                  {% if r.info %}
                    <small class="text-muted">{{ r.info }}</small>
                  {% else %}
                    <small class="text-success">Cropped successfully</small>
                  {% endif %}
                </td>
                <td>
                  <a href="{{ r.download }}" class="btn btn-outline-success btn-sm" download>
                    <i class="fas fa-download me-1"></i>Download
                  </a>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer bg-light">
        <div class="row align-items-center">
          <!-- Add More Watermarks Button -->
          <div class="col-md-4">
            <a href="/crop" class="btn btn-secondary">
              <i class="fas fa-plus me-1"></i>Crop More Images
            </a>
          </div>

          <!-- Share Section -->
          <div class="col-md-8">
            <div class="d-flex justify-content-end align-items-center flex-wrap">
              <!-- "Loved it?" Message -->
              <div class="me-3 mb-2 mb-md-0">
                <span class="text-muted">
                  <i class="fas fa-heart text-danger me-1 heartbeat-icon"></i>
                  <small>Loved it? Share with others!</small>
                </span>
              </div>

              <!-- Individual Share Icons with SVG -->
              <div class="share-icons d-flex gap-2 align-items-center">
                <!-- Twitter -->
                <button class="btn btn-outline-primary btn-sm share-btn twitter-btn"
                        onclick="shareOnTwitter()"
                        title="Share on Twitter"
                        data-bs-toggle="tooltip">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                  </svg>
                </button>

                <!-- Facebook -->
                <button class="btn btn-outline-primary btn-sm share-btn facebook-btn"
                        onclick="shareOnFacebook()"
                        title="Share on Facebook"
                        data-bs-toggle="tooltip">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                  </svg>
                </button>

                <!-- LinkedIn -->
                <button class="btn btn-outline-info btn-sm share-btn linkedin-btn"
                        onclick="shareOnLinkedIn()"
                        title="Share on LinkedIn"
                        data-bs-toggle="tooltip">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                  </svg>
                </button>

                <!-- WhatsApp -->
                <button class="btn btn-outline-success btn-sm share-btn whatsapp-btn"
                        onclick="shareOnWhatsApp()"
                        title="Share on WhatsApp"
                        data-bs-toggle="tooltip">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893A11.821 11.821 0 0020.531 3.488"/>
                  </svg>
                </button>

                <!-- Instagram -->
                <button class="btn btn-outline-danger btn-sm share-btn instagram-btn"
                        onclick="shareOnInstagram()"
                        title="Share on Instagram"
                        data-bs-toggle="tooltip">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                  </svg>
                </button>

                <!-- More Options Dropdown -->
                <div class="btn-group">
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm dropdown-toggle share-btn more-btn"
                          data-bs-toggle="dropdown"
                          aria-expanded="false"
                          title="More sharing options"
                          data-bs-original-title="More sharing options">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                    <li><h6 class="dropdown-header text-primary">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
                        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                      </svg>More Options
                    </h6></li>
                    <li><a class="dropdown-item" href="#" onclick="copyToClipboard()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                      </svg>Copy Link
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="shareViaEmail()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                      </svg>Email
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="shareViaSMS()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                      </svg>SMS
                    </a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if all_downloads and all_downloads|length > 0 %}
<script>
// Set up the download all functionality
document.getElementById("downloadAll")?.addEventListener("click", function() {
  const files = {{ all_downloads|tojson }};
  files.forEach((url, i) => {
    setTimeout(() => {
      const link = document.createElement('a');
      link.href = url;
      link.download = '';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }, i * 300);
  });
});
</script>
{% endif %}
{% endif %}

<div class="row justify-content-center mt-4">
  <div class="col-lg-8">
    <div class="card bg-light">
      <div class="card-body">
        <h5 class="card-title">Cropping Tips</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <h6><i class="fas fa-lightbulb text-warning me-1"></i>Best Practices</h6>
            <ul class="small">
              <li>Use presets for common aspect ratios</li>
              <li>Consider the main subject when positioning crop area</li>
              <li>Leave some padding around important elements</li>
              <li>Square crops work well for profile pictures</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-ruler text-primary me-1"></i>Measurement Guide</h6>
            <ul class="small">
              <li>X/Y positions start from top-left corner (0,0)</li>
              <li>Width/Height define the crop area size</li>
              <li>Ensure crop area doesn't exceed image boundaries</li>
              <li>Use whole numbers for pixel-perfect crops</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// COMPLETELY ISOLATED FILE UPLOAD HANDLER - NO DOUBLE PROMPTS
(function() {
  'use strict';
  
  // Wait for DOM to be fully loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFileUpload);
  } else {
    initFileUpload();
  }
  
  function initFileUpload() {
    console.log('Initializing file upload...');
    
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const selectionInfo = document.getElementById('selectionInfo');
    const fileCount = document.getElementById('fileCount');
    const thumbnails = document.getElementById('thumbnails');
    
    if (!dropArea || !fileInput) {
      console.error('Required elements not found');
      return;
    }
    
    // Remove any existing event listeners to prevent conflicts
    const newDropArea = dropArea.cloneNode(true);
    dropArea.parentNode.replaceChild(newDropArea, dropArea);
    
    const newFileInput = fileInput.cloneNode(true);
    fileInput.parentNode.replaceChild(newFileInput, fileInput);
    
    // Update references to new elements
    const cleanDropArea = document.getElementById('dropArea');
    const cleanFileInput = document.getElementById('fileInput');
    
    let isProcessing = false; // Prevent multiple simultaneous file operations
    
    // Single click handler - no conflicts
    cleanDropArea.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopImmediatePropagation();
      
      if (isProcessing) return;
      console.log('Drop area clicked, opening file dialog...');
      
      cleanFileInput.click();
    }, { once: false, passive: false });
    
    // File input change handler
    cleanFileInput.addEventListener('change', function(e) {
      console.log('File input changed:', e.target.files.length, 'files');
      if (isProcessing) return;
      
      handleFiles(e.target.files);
    });
    
    // Drag and drop handlers
    cleanDropArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      cleanDropArea.classList.add('dragover');
    });
    
    cleanDropArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      if (!cleanDropArea.contains(e.relatedTarget)) {
        cleanDropArea.classList.remove('dragover');
      }
    });
    
    cleanDropArea.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      cleanDropArea.classList.remove('dragover');
      
      if (isProcessing) return;
      console.log('Files dropped:', e.dataTransfer.files.length, 'files');
      
      const files = e.dataTransfer.files;
      cleanFileInput.files = files;
      handleFiles(files);
    });
    
    function handleFiles(files) {
      if (isProcessing) return;
      isProcessing = true;
      
      console.log('Processing files:', files.length);
      
      if (files && files.length > 0) {
        if (selectionInfo) selectionInfo.style.display = 'block';
        if (fileCount) fileCount.textContent = files.length;
        if (thumbnails) thumbnails.innerHTML = '';
        
        Array.from(files).forEach(file => {
          if (!file.type.match('image.*')) {
            console.warn('Skipping non-image file:', file.name);
            return;
          }
          
          const div = document.createElement('div');
          div.className = 'thumbnail me-2 mb-2';
          div.innerHTML = `
            <small class="text-truncate d-block" style="max-width: 120px;" title="${file.name}">
              <i class="fas fa-file-image text-success me-1"></i>${file.name}
            </small>
            <small class="text-muted">${formatFileSize(file.size)}</small>
          `;
          if (thumbnails) thumbnails.appendChild(div);
        });
      } else {
        if (selectionInfo) selectionInfo.style.display = 'none';
      }
      
      setTimeout(() => { isProcessing = false; }, 100);
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  }
})();

// Crop preview functionality
document.addEventListener('DOMContentLoaded', function() {
  const cropX = document.getElementById('cropX');
  const cropY = document.getElementById('cropY');
  const cropWidth = document.getElementById('cropWidth');
  const cropHeight = document.getElementById('cropHeight');
  const cropArea = document.getElementById('cropArea');
  const previewDimensions = document.getElementById('previewDimensions');
  const presetButtons = document.querySelectorAll('.preset-btn');

  if (!cropWidth || !cropHeight || !cropArea || !previewDimensions) return;

  function updatePreview() {
    const width = parseInt(cropWidth.value) || 500;
    const height = parseInt(cropHeight.value) || 500;
    
    const maxSize = 300;
    const scale = Math.min(maxSize / Math.max(width, height), 1);
    const previewWidth = width * scale;
    const previewHeight = height * scale;
    
    cropArea.style.width = previewWidth + 'px';
    cropArea.style.height = previewHeight + 'px';
    previewDimensions.textContent = width + 'Ã—' + height;
  }

  presetButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const ratio = this.dataset.ratio;
      const baseSize = 600;
      
      presetButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      switch(ratio) {
        case '1:1':
          cropWidth.value = baseSize;
          cropHeight.value = baseSize;
          break;
        case '4:3':
          cropWidth.value = baseSize;
          cropHeight.value = Math.round(baseSize * 3/4);
          break;
        case '16:9':
          cropWidth.value = baseSize;
          cropHeight.value = Math.round(baseSize * 9/16);
          break;
        case '3:2':
          cropWidth.value = baseSize;
          cropHeight.value = Math.round(baseSize * 2/3);
          break;
      }
      updatePreview();
    });
  });

  [cropWidth, cropHeight].forEach(input => {
    input.addEventListener('input', updatePreview);
  });

  updatePreview();
});

// Social media sharing functions
function shareOnTwitter() {
  const shareUrl = window.location.href;
  const shareText = "I just cropped my photos using this amazing free online tool! Check it out:";
  const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
  window.open(twitterUrl, '_blank', 'width=550,height=420');
}

function shareOnFacebook() {
  const shareUrl = window.location.href;
  const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
  window.open(facebookUrl, '_blank', 'width=550,height=420');
}

function shareOnLinkedIn() {
  const shareUrl = window.location.href;
  const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`;
  window.open(linkedinUrl, '_blank', 'width=550,height=420');
}

function shareOnWhatsApp() {
  const shareUrl = window.location.href;
  const shareText = "I just cropped my photos using this amazing free online tool! Check it out:";
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
  window.open(whatsappUrl, '_blank');
}

function shareOnInstagram() {
  copyToClipboard();
  alert('Link copied to clipboard! You can now paste it in your Instagram post or story.');
}

function copyToClipboard() {
  const shareUrl = window.location.href;
  navigator.clipboard.writeText(shareUrl).then(function() {
    const toast = document.createElement('div');
    toast.textContent = 'Link copied to clipboard!';
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
      }
    }, 3000);
  }).catch(function(err) {
    console.error('Could not copy text: ', err);
    const textArea = document.createElement('textarea');
    textArea.value = shareUrl;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('Link copied to clipboard!');
  });
}

function shareViaEmail() {
  const shareUrl = window.location.href;
  const shareTitle = "Crop Images Online - resizeimages.co.in";
  const shareText = "I just cropped my photos using this amazing free online tool! Check it out:";
  const emailUrl = `mailto:?subject=${encodeURIComponent(shareTitle)}&body=${encodeURIComponent(shareText + '\n\n' + shareUrl)}`;
  window.location.href = emailUrl;
}

function shareViaSMS() {
  const shareUrl = window.location.href;
  const shareText = "I just cropped my photos using this amazing free online tool! Check it out:";
  const smsUrl = `sms:?body=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
  window.location.href = smsUrl;
}
</script>

<style>
.share-btn {
  width: 36px;
  height: 36px;
  border-radius: 50% !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  border-width: 1.5px !important;
}

.share-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.twitter-btn:hover {
  background: #1da1f2 !important;
  border-color: #1da1f2 !important;
  color: white !important;
}

.facebook-btn:hover {
  background: #4267B2 !important;
  border-color: #4267B2 !important;
  color: white !important;
}

.linkedin-btn:hover {
  background: #0077b5 !important;
  border-color: #0077b5 !important;
  color: white !important;
}

.whatsapp-btn:hover {
  background: #25d366 !important;
  border-color: #25d366 !important;
  color: white !important;
}

.instagram-btn:hover {
  background: linear-gradient(45deg, #e4405f, #c13584) !important;
  border-color: #e4405f !important;
  color: white !important;
}

.more-btn:hover {
  background: #6c757d !important;
  border-color: #6c757d !important;
  color: white !important;
}

.heartbeat-icon {
  animation: heartbeat 2s ease-in-out infinite;
}

@keyframes heartbeat {
  0% { transform: scale(1); }
  14% { transform: scale(1.1); }
  28% { transform: scale(1); }
  42% { transform: scale(1.1); }
  70% { transform: scale(1); }
}

@media (max-width: 768px) {
  .share-icons {
    justify-content: center;
    margin-top: 10px;
  }

  .share-btn {
    width: 32px;
    height: 32px;
  }

  .col-md-4, .col-md-8 {
    text-align: center;
  }
}

.dropdown-menu {
  border: none;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
}

.dropdown-item {
  transition: all 0.2s ease;
  border-radius: 8px;
  margin: 2px 8px;
}

.dropdown-item:hover {
  background: linear-gradient(45deg, #f8f9fa, #e9ecef);
  transform: translateX(5px);
}

.dropArea {
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 40px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.dropArea:hover, .dropArea.dragover {
  border-color: #198754;
  background-color: #f8f9fa;
}

.thumbnail {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 8px;
  max-width: 150px;
  text-align: center;
}

.preset-btn.active {
  background-color: #198754;
  border-color: #198754;
  color: white;
}

#cropPreview {
  min-height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>
{% endblock %}
